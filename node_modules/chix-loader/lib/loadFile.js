'use strict';

var parser = require('fbpx/chix')();
var fs = require('fs');
var util = require('util');

/**
 *
 * Loads an .fbp or .json file from disk and
 * passes the nodeDefinition to the callback
 *
 * e.g.
 *   provider ./{ns}/{name} as x
 *   MyGraph(x:common/graph)
 *
 */
module.exports = function loadFile(d, cb) {
  fs.exists(d.path, function(exists) {

    if (exists) {

      fs.readFile(d.path, function(err, content) {

        if (err) {
          cb(err);
        } else {

          var data;

          if (/^\s*{/.test(content)) { // test for json

            data = JSON.parse(content);

            cb(null, {
              providerLocation: d.providerLocation,
              nodeDef: data
            });

          } else if (d.path.indexOf('.fbp') !== -1) {

            data = parser.parse(content);

            cb(null, {
              providerLocation: d.providerLocation,
              nodeDef: data
            });

          } else {
            cb(util.format('Could not recognize file format for: %s', d.path));
          }
        }

      });

    } else {
      cb(Error(util.format('File %s does not exist.', d.path)));
    }
  });
};
